# RAG系统准确性测试指南

本指南介绍如何使用RAG（检索增强生成）系统的准确性和合理性测试套件。

## 概述

RAG准确性测试专门验证系统在不同学科、年级、课题组合下的匹配准确性，确保检索到的参考资料与用户输入高度相关。

## 快速开始

### 1. 运行完整测试

```bash
# 在server目录下运行
npm run test:rag-accuracy
```

这将运行所有测试用例，包括：
- ✅ 精确匹配测试
- ✅ 学科匹配测试  
- ✅ 年级兼容性测试
- ✅ 跨学科内容测试
- ✅ 边界情况测试
- ✅ 模糊查询测试
- ✅ 负面测试（不匹配内容）

### 2. 运行快速测试

```bash
npm run test:rag-accuracy:quick
```

仅运行核心测试用例，适合快速验证系统状态。

### 3. 学科专项测试

```bash
# 数学学科深度测试
npm run test:rag-accuracy:math

# 语文学科深度测试  
npm run test:rag-accuracy:chinese

# 英语学科深度测试
npm run test:rag-accuracy:english

# 生物学科深度测试（您提到的藻类植物问题）
npm run test:rag-accuracy:biology
```

## 测试分类详解

### 1. 精确匹配测试
验证学科、年级、课题完全对应时的匹配准确性。

**示例测试用例：**
- 数学 + 三年级 + 加法运算
- 语文 + 五年级 + 古诗词鉴赏

**评判标准：**
- 学科匹配度 ≥ 80%
- 年级匹配度 ≥ 60%（允许相邻年级）
- 相关性分数 ≥ 0.6

### 2. 学科匹配测试
专门测试学科专业术语的匹配能力。

**示例测试用例：**
- 物理 + 八年级 + 力的作用
- **生物 + 七年级 + 藻类植物** ⭐

**评判标准：**
- 学科匹配度 ≥ 70%
- 相关性分数 ≥ 0.5

### 3. 年级兼容性测试
测试不同年级内容的适配能力。

**评判标准：**
- 低年级内容不应匹配高年级资料
- 允许相邻年级的适度匹配

### 4. 边界情况测试
测试非主科和特殊情况。

**示例测试用例：**
- 音乐 + 四年级 + 节拍练习
- 美术 + 二年级 + 色彩搭配

### 5. 负面测试
验证系统正确过滤不合适内容的能力。

**示例测试用例：**
- 数学 + 一年级 + 微积分原理（应该被过滤）
- 体育 + 五年级 + 量子物理（完全无关）

## 测试结果解读

### 输出格式

每个测试会显示：
```
🔍 测试: 测试生物学科特定内容匹配
   学科: 生物 | 年级: 七年级 | 课题: 藻类植物
   ✅ 测试通过
   📊 结果数量: 8 (使用: 5)
   🎯 学科匹配: 75.0% (6/8)
   📚 年级匹配: 62.5% (5/8)
   ⭐ 平均相关性: 0.654
   📋 主要来源:
     1. ✅✅ 七年级生物苏教版电子课本.pdf
     2. ✅❌ 八年级生物人教版电子课本.pdf
     3. ❌✅ 六年级科学教科版电子课本.pdf
```

### 关键指标说明

1. **学科匹配度**：检索结果中包含目标学科的百分比
2. **年级匹配度**：检索结果中包含合适年级的百分比
3. **平均相关性**：内容相关性的数值评分（0-1）
4. **主要来源**：前几个检索结果的详细分析

### 问题识别

测试会自动识别常见问题：
- 学科匹配度过低
- 年级匹配度过低
- 相关性分数过低
- 没有找到任何参考资料

## 综合报告

测试完成后会生成详细报告，包括：

### 1. 总体统计
- 总测试数
- 成功/失败数量
- 总体准确率

### 2. 分类统计
各个测试分类的通过率

### 3. 质量指标
- 平均学科匹配度
- 平均年级匹配度  
- 平均相关性分数

### 4. 改进建议
基于测试结果的具体改进建议

## 解决您提到的问题

针对您提到的"藻类植物"课题返回"数学八年级"和"英语六年级"资料的问题：

### 1. 运行生物学科测试
```bash
npm run test:rag-accuracy:biology
```

### 2. 查看具体测试用例
测试套件包含了针对"藻类植物"的专门测试：
```javascript
{
  category: "学科匹配",
  subject: "生物",
  grade: "七年级", 
  topic: "藻类植物",
  expectedSubjects: ["生物"],
  expectedGrades: ["七年级", "六年级", "八年级"],
  minRelevanceScore: 0.5
}
```

### 3. 问题诊断
测试会显示：
- 为什么返回了数学和英语资料
- 这些资料的相关性分数
- 学科匹配算法的具体问题

### 4. 持续监控
建议定期运行测试：
```bash
# 每次更新RAG数据后
npm run test:rag-accuracy

# 快速验证核心功能
npm run test:rag-accuracy:quick

# 针对问题学科深度测试
npm run test:rag-accuracy:biology
```

## 测试结果存储

所有测试结果会保存到 `server/rag/test-results/` 目录：
- JSON格式：详细的结构化数据
- TXT格式：易读的文本报告

文件命名格式：
- `rag-accuracy-full-2024-01-15T10-30-45.json`
- `rag-accuracy-subject-生物-2024-01-15T10-30-45.txt`

## 集成到CI/CD

可以将测试集成到持续集成流程：

```yaml
# .github/workflows/test.yml
- name: Run RAG Accuracy Tests
  run: |
    cd server
    npm run test:rag-accuracy:quick
```

## 自定义测试

### 添加新的测试用例

编辑 `server/rag/tests/rag-accuracy-test.js`：

```javascript
{
  category: "自定义测试",
  subject: "您的学科",
  grade: "您的年级",
  topic: "您的课题",
  expectedSubjects: ["期望的学科"],
  expectedGrades: ["期望的年级"],
  minRelevanceScore: 0.4,
  description: "测试描述"
}
```

### 调整评判标准

根据实际需求修改匹配阈值：
- `minRelevanceScore`：相关性最低要求
- `expectedGrades`：允许的年级范围
- 分析函数中的准确率要求

## 故障排除

### 常见问题

1. **没有找到任何参考资料**
   - 检查向量数据库是否正确初始化
   - 确认有相关学科的教学资料

2. **学科匹配度过低**
   - 检查文件命名是否包含学科信息
   - 优化学科识别算法

3. **年级匹配度过低**
   - 检查年级标准化映射
   - 调整年级兼容性策略

4. **相关性分数过低**
   - 优化向量嵌入模型
   - 调整搜索权重和阈值

### 调试技巧

1. **查看详细日志**
   ```bash
   DEBUG=rag:* npm run test:rag-accuracy:biology
   ```

2. **单独测试特定用例**
   修改测试文件，只保留需要调试的测试用例

3. **分析检索结果**
   查看 `contextResult.sources` 了解具体返回了哪些资料

## 总结

通过这套测试系统，您可以：
- ✅ 系统性评估RAG匹配准确性
- ✅ 识别具体的匹配问题
- ✅ 跟踪改进效果
- ✅ 确保系统稳定性
- ✅ 为优化提供数据支持

建议将此测试纳入日常开发流程，确保RAG系统始终提供高质量的参考资料。 