# ğŸ§ª è½¯ä»¶æµ‹è¯•è¿è¡ŒæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å±•ç¤ºäº†å¦‚ä½•åœ¨ TeachAI é¡¹ç›®ä¸­è¿è¡Œè½¯ä»¶æµ‹è¯•ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œ E2E æµ‹è¯•ã€‚

## ğŸ¯ æµ‹è¯•ç±»å‹

### 1. å•å…ƒæµ‹è¯•

- **ç›®çš„**: æµ‹è¯•å•ä¸ªå‡½æ•°å’Œç»„ä»¶
- **å·¥å…·**: Jest + React Testing Library
- **è¦†ç›–èŒƒå›´**: å‡½æ•°é€»è¾‘ã€ç»„ä»¶æ¸²æŸ“ã€ç”¨æˆ·äº¤äº’

### 2. é›†æˆæµ‹è¯•

- **ç›®çš„**: æµ‹è¯•å¤šä¸ªæ¨¡å—ä¹‹é—´çš„äº¤äº’
- **å·¥å…·**: Jest + Supertest
- **è¦†ç›–èŒƒå›´**: API ç«¯ç‚¹ã€æ•°æ®åº“æ“ä½œã€æœåŠ¡é›†æˆ

### 3. E2E æµ‹è¯•

- **ç›®çš„**: æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æµç¨‹
- **å·¥å…·**: Playwright
- **è¦†ç›–èŒƒå›´**: ç”¨æˆ·ç•Œé¢ã€ä¸šåŠ¡æµç¨‹ã€ç³»ç»Ÿé›†æˆ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# é¡¹ç›®æ ¹ç›®å½•
pnpm install

# æˆ–åˆ†åˆ«å®‰è£…
cd web && pnpm install
cd server && pnpm install
cd e2e && pnpm install
```

### 2. è¿è¡Œæµ‹è¯•

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
node scripts/run-tests.js

# è¿è¡Œç‰¹å®šç±»å‹æµ‹è¯•
node scripts/run-tests.js unit
node scripts/run-tests.js integration
node scripts/run-tests.js e2e

# è¿è¡Œå‰ç«¯æˆ–åç«¯æµ‹è¯•
node scripts/run-tests.js frontend
node scripts/run-tests.js backend
```

#### æ–¹å¼äºŒï¼šç®€åŒ–æµ‹è¯•è„šæœ¬

```bash
# æ˜¾ç¤ºå¸®åŠ©
node scripts/simple-test.js

# è¿è¡Œåç«¯æµ‹è¯•
node scripts/simple-test.js backend

# è¿è¡Œå‰ç«¯æµ‹è¯•
node scripts/simple-test.js frontend
```

#### æ–¹å¼ä¸‰ï¼šç›´æ¥è¿è¡Œ

```bash
# åç«¯æµ‹è¯•
cd server
npm test

# å‰ç«¯æµ‹è¯•
cd web
npm test

# E2Eæµ‹è¯•
cd e2e
npm test
```

## ğŸ“ æµ‹è¯•ç¤ºä¾‹

### åç«¯å•å…ƒæµ‹è¯•ç¤ºä¾‹

```javascript
// server/__tests__/basic.test.js
describe("åŸºç¡€åŠŸèƒ½æµ‹è¯•", () => {
  test("æ•°å­¦è¿ç®—æµ‹è¯•", () => {
    expect(2 + 2).toBe(4);
    expect(10 - 5).toBe(5);
    expect(3 * 4).toBe(12);
    expect(8 / 2).toBe(4);
  });

  test("å¼‚æ­¥æ“ä½œæµ‹è¯•", async () => {
    const promise = new Promise((resolve) => {
      setTimeout(() => resolve("å®Œæˆ"), 100);
    });

    const result = await promise;
    expect(result).toBe("å®Œæˆ");
  });
});
```

### å‰ç«¯ç»„ä»¶æµ‹è¯•ç¤ºä¾‹

```typescript
// web/src/components/__tests__/StreamingMarkdown.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import StreamingMarkdown from '../streaming-markdown';

describe('StreamingMarkdown', () => {
  test('renders static content correctly', () => {
    render(
      <StreamingMarkdown
        content="# æµ‹è¯•æ ‡é¢˜"
        isStreaming={false}
      />
    );

    expect(screen.getByText('æµ‹è¯•æ ‡é¢˜')).toBeInTheDocument();
  });
});
```

### API é›†æˆæµ‹è¯•ç¤ºä¾‹

```javascript
// server/__tests__/integration/content-api.test.js
const request = require("supertest");
const app = require("../../server");

describe("å†…å®¹APIé›†æˆæµ‹è¯•", () => {
  test("æˆåŠŸåˆ›å»ºæ•™æ¡ˆ", async () => {
    const response = await request(app).post("/api/content/lesson-plans").send({
      title: "æµ‹è¯•æ•™æ¡ˆ",
      subject: "æ•°å­¦",
      grade: "ä¸‰å¹´çº§",
    });

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
  });
});
```

### E2E æµ‹è¯•ç¤ºä¾‹

```javascript
// e2e/tests/lesson-plan.spec.js
import { test, expect } from "@playwright/test";

test("ç”¨æˆ·å¯ä»¥ç”Ÿæˆæ•™æ¡ˆ", async ({ page }) => {
  await page.goto("http://localhost:3000");

  await page.fill('[data-testid="subject-input"]', "æ•°å­¦");
  await page.fill('[data-testid="grade-input"]', "ä¸‰å¹´çº§");
  await page.click('[data-testid="generate-button"]');

  await expect(
    page.locator('[data-testid="lesson-plan-content"]'),
  ).toBeVisible();
});
```

## ğŸ›ï¸ æµ‹è¯•å‘½ä»¤è¯¦è§£

### åç«¯æµ‹è¯•å‘½ä»¤

```bash
cd server

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npm test -- --testPathPattern=basic.test.js

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# ç›‘è§†æ¨¡å¼
npm run test:watch

# è¿è¡Œé›†æˆæµ‹è¯•
npm test -- --testPathPattern=integration

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
npm test -- --verbose
```

### å‰ç«¯æµ‹è¯•å‘½ä»¤

```bash
cd web

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npm test -- StreamingMarkdown.test.tsx

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --coverage

# éç›‘è§†æ¨¡å¼
npm test -- --watchAll=false

# è¿è¡ŒåŒ¹é…ç‰¹å®šæ¨¡å¼çš„æµ‹è¯•
npm test -- --testNamePattern="renders static content"
```

### E2E æµ‹è¯•å‘½ä»¤

```bash
cd e2e

# è¿è¡Œæ‰€æœ‰E2Eæµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµè§ˆå™¨çš„æµ‹è¯•
npx playwright test --project=chromium

# æ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢
npx playwright test --headed

# ç”ŸæˆHTMLæŠ¥å‘Š
npx playwright test --reporter=html

# è°ƒè¯•æ¨¡å¼
npx playwright test --debug
```

## ğŸ“Š æµ‹è¯•ç»“æœç¤ºä¾‹

### æˆåŠŸçš„æµ‹è¯•è¾“å‡º

```
 PASS  __tests__/basic.test.js
  åŸºç¡€åŠŸèƒ½æµ‹è¯•
    âœ“ æ•°å­¦è¿ç®—æµ‹è¯• (1 ms)
    âœ“ å­—ç¬¦ä¸²æ“ä½œæµ‹è¯•
    âœ“ æ•°ç»„æ“ä½œæµ‹è¯•
    âœ“ å¯¹è±¡æ“ä½œæµ‹è¯•
    âœ“ å¼‚æ­¥æ“ä½œæµ‹è¯• (102 ms)
    âœ“ é”™è¯¯å¤„ç†æµ‹è¯• (5 ms)
  å®ç”¨å‡½æ•°æµ‹è¯•
    âœ“ è®¡ç®—å™¨åŠ æ³•
    âœ“ è®¡ç®—å™¨å‡æ³•
    âœ“ è®¡ç®—å™¨ä¹˜æ³•
    âœ“ è®¡ç®—å™¨é™¤æ³•
  æ—¥æœŸæ—¶é—´æµ‹è¯•
    âœ“ å½“å‰æ—¥æœŸæµ‹è¯• (1 ms)
    âœ“ æ—¥æœŸæ ¼å¼åŒ–æµ‹è¯•
    âœ“ æ—¶é—´æˆ³æµ‹è¯•
  æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•
    âœ“ é‚®ç®±éªŒè¯
    âœ“ æ‰‹æœºå·éªŒè¯
    âœ“ ä¸­æ–‡å­—ç¬¦éªŒè¯
  æ€§èƒ½æµ‹è¯•
    âœ“ æ•°ç»„æ“ä½œæ€§èƒ½ (1 ms)
    âœ“ å­—ç¬¦ä¸²æ“ä½œæ€§èƒ½
  æ¨¡æ‹Ÿæµ‹è¯•
    âœ“ å‡½æ•°æ¨¡æ‹Ÿ
    âœ“ è¿”å›å€¼æ¨¡æ‹Ÿ
    âœ“ å¼‚æ­¥æ¨¡æ‹Ÿ

Test Suites: 1 passed, 1 total
Tests:       21 passed, 21 total
Snapshots:   0 total
Time:        0.204 s
```

## ğŸ”§ æµ‹è¯•é…ç½®

### Jest é…ç½®æ–‡ä»¶

```javascript
// jest.config.js
module.exports = {
  testEnvironment: "node", // åç«¯ä½¿ç”¨nodeï¼Œå‰ç«¯ä½¿ç”¨jsdom
  setupFilesAfterEnv: ["<rootDir>/jest.setup.js"],
  collectCoverageFrom: [
    "**/*.{js,jsx,ts,tsx}",
    "!**/node_modules/**",
    "!**/coverage/**",
  ],
  testMatch: [
    "**/__tests__/**/*.(js|jsx|ts|tsx)",
    "**/*.(test|spec).(js|jsx|ts|tsx)",
  ],
  coverageReporters: ["text", "lcov", "html"],
  testTimeout: 30000,
  verbose: true,
};
```

### æµ‹è¯•è®¾ç½®æ–‡ä»¶

```javascript
// jest.setup.js
// Mock environment variables
process.env.NODE_ENV = "test";
process.env.QWEN_API_KEY = "test-api-key";

// Mock console to reduce noise
global.console = {
  ...console,
  log: jest.fn(),
  debug: jest.fn(),
  info: jest.fn(),
  warn: jest.fn(),
  error: jest.fn(),
};

// Global test timeout
jest.setTimeout(30000);
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. æµ‹è¯•è¶…æ—¶

**é—®é¢˜**: æµ‹è¯•è¿è¡Œè¶…æ—¶

```bash
Timeout - Async callback was not invoked within the 5000ms timeout
```

**è§£å†³æ–¹æ¡ˆ**:

```javascript
// å¢åŠ å•ä¸ªæµ‹è¯•è¶…æ—¶æ—¶é—´
test("é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•", async () => {
  // æµ‹è¯•ä»£ç 
}, 10000); // 10ç§’è¶…æ—¶

// æˆ–åœ¨é…ç½®ä¸­è®¾ç½®å…¨å±€è¶…æ—¶
// jest.config.js
module.exports = {
  testTimeout: 30000, // 30ç§’
};
```

### 2. æ¨¡å—æ‰¾ä¸åˆ°

**é—®é¢˜**:

```bash
Cannot find module '@/components/Button'
```

**è§£å†³æ–¹æ¡ˆ**:

```javascript
// jest.config.js
module.exports = {
  moduleNameMapping: {
    "^@/(.*)$": "<rootDir>/src/$1",
  },
};
```

### 3. å¼‚æ­¥æµ‹è¯•é—®é¢˜

**é—®é¢˜**: å¼‚æ­¥æ“ä½œæœªæ­£ç¡®å¤„ç†

**è§£å†³æ–¹æ¡ˆ**:

```javascript
// ä½¿ç”¨ async/await
test("å¼‚æ­¥æµ‹è¯•", async () => {
  const result = await asyncFunction();
  expect(result).toBe("expected");
});

// ä½¿ç”¨ waitFor
import { waitFor } from "@testing-library/react";

test("ç­‰å¾…å¼‚æ­¥æ›´æ–°", async () => {
  render(<AsyncComponent />);

  await waitFor(() => {
    expect(screen.getByText("åŠ è½½å®Œæˆ")).toBeInTheDocument();
  });
});
```

## ğŸ“ˆ è¦†ç›–ç‡æŠ¥å‘Š

### æŸ¥çœ‹è¦†ç›–ç‡

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# æŸ¥çœ‹HTMLæŠ¥å‘Š
open coverage/lcov-report/index.html
```

### è¦†ç›–ç‡ç›®æ ‡

- **è¯­å¥è¦†ç›–ç‡**: > 80%
- **åˆ†æ”¯è¦†ç›–ç‡**: > 75%
- **å‡½æ•°è¦†ç›–ç‡**: > 85%
- **è¡Œè¦†ç›–ç‡**: > 80%

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

1. **æµ‹è¯•å‘½åè¦æ¸…æ™°**: ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
2. **éµå¾ª AAA æ¨¡å¼**: Arrange, Act, Assert
3. **ä¿æŒæµ‹è¯•ç‹¬ç«‹**: æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ
4. **ä½¿ç”¨é€‚å½“çš„æ–­è¨€**: é€‰æ‹©æœ€åˆé€‚çš„ expect æ–¹æ³•
5. **æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–**: ä½¿ç”¨ Mock éš”ç¦»æµ‹è¯•ç¯å¢ƒ
6. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**: åŒ…å«æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µ
7. **ä¿æŒæµ‹è¯•ç®€å•**: ä¸€ä¸ªæµ‹è¯•åªæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½ç‚¹

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actions ç¤ºä¾‹

```yaml
name: æµ‹è¯•

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "18"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: è¿è¡Œæµ‹è¯•
        run: node scripts/run-tests.js
```

## ğŸ“š æ›´å¤šèµ„æº

- [Jest å®˜æ–¹æ–‡æ¡£](https://jestjs.io/docs/getting-started)
- [React Testing Library](https://testing-library.com/docs/react-testing-library/intro/)
- [Playwright æ–‡æ¡£](https://playwright.dev/docs/intro)
- [æµ‹è¯•æœ€ä½³å®è·µ](https://github.com/goldbergyoni/javascript-testing-best-practices)

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨å­¦ä¼šäº†ï¼š

1. âœ… å¦‚ä½•è¿è¡Œä¸åŒç±»å‹çš„æµ‹è¯•
2. âœ… å¦‚ä½•ç¼–å†™å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œ E2E æµ‹è¯•
3. âœ… å¦‚ä½•ä½¿ç”¨æµ‹è¯•å·¥å…·å’Œé…ç½®
4. âœ… å¦‚ä½•è§£å†³å¸¸è§çš„æµ‹è¯•é—®é¢˜
5. âœ… å¦‚ä½•ç”Ÿæˆå’Œåˆ†æè¦†ç›–ç‡æŠ¥å‘Š

è®°ä½ï¼Œå¥½çš„æµ‹è¯•ä¸ä»…èƒ½å‘ç° bugï¼Œè¿˜èƒ½ä½œä¸ºä»£ç çš„æ–‡æ¡£ï¼Œå¸®åŠ©å›¢é˜Ÿæ›´å¥½åœ°ç†è§£å’Œç»´æŠ¤ä»£ç ã€‚

**ç«‹å³å¼€å§‹æµ‹è¯•**ï¼š

```bash
# è¿è¡ŒåŸºç¡€æµ‹è¯•
cd server && npm test -- --testPathPattern=basic.test.js

# æˆ–ä½¿ç”¨ç®€åŒ–è„šæœ¬
node scripts/simple-test.js backend
```
