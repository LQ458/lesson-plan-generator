# 🧪 软件测试运行指南

## 📋 概述

本指南展示了如何在 TeachAI 项目中运行软件测试，包括单元测试、集成测试和 E2E 测试。

## 🎯 测试类型

### 1. 单元测试

- **目的**: 测试单个函数和组件
- **工具**: Jest + React Testing Library
- **覆盖范围**: 函数逻辑、组件渲染、用户交互

### 2. 集成测试

- **目的**: 测试多个模块之间的交互
- **工具**: Jest + Supertest
- **覆盖范围**: API 端点、数据库操作、服务集成

### 3. E2E 测试

- **目的**: 测试完整的用户流程
- **工具**: Playwright
- **覆盖范围**: 用户界面、业务流程、系统集成

## 🚀 快速开始

### 1. 安装依赖

```bash
# 项目根目录
pnpm install

# 或分别安装
cd web && pnpm install
cd server && pnpm install
cd e2e && pnpm install
```

### 2. 运行测试

#### 方式一：使用测试脚本（推荐）

```bash
# 运行所有测试
node scripts/run-tests.js

# 运行特定类型测试
node scripts/run-tests.js unit
node scripts/run-tests.js integration
node scripts/run-tests.js e2e

# 运行前端或后端测试
node scripts/run-tests.js frontend
node scripts/run-tests.js backend
```

#### 方式二：简化测试脚本

```bash
# 显示帮助
node scripts/simple-test.js

# 运行后端测试
node scripts/simple-test.js backend

# 运行前端测试
node scripts/simple-test.js frontend
```

#### 方式三：直接运行

```bash
# 后端测试
cd server
npm test

# 前端测试
cd web
npm test

# E2E测试
cd e2e
npm test
```

## 📝 测试示例

### 后端单元测试示例

```javascript
// server/__tests__/basic.test.js
describe("基础功能测试", () => {
  test("数学运算测试", () => {
    expect(2 + 2).toBe(4);
    expect(10 - 5).toBe(5);
    expect(3 * 4).toBe(12);
    expect(8 / 2).toBe(4);
  });

  test("异步操作测试", async () => {
    const promise = new Promise((resolve) => {
      setTimeout(() => resolve("完成"), 100);
    });

    const result = await promise;
    expect(result).toBe("完成");
  });
});
```

### 前端组件测试示例

```typescript
// web/src/components/__tests__/StreamingMarkdown.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import StreamingMarkdown from '../streaming-markdown';

describe('StreamingMarkdown', () => {
  test('renders static content correctly', () => {
    render(
      <StreamingMarkdown
        content="# 测试标题"
        isStreaming={false}
      />
    );

    expect(screen.getByText('测试标题')).toBeInTheDocument();
  });
});
```

### API 集成测试示例

```javascript
// server/__tests__/integration/content-api.test.js
const request = require("supertest");
const app = require("../../server");

describe("内容API集成测试", () => {
  test("成功创建教案", async () => {
    const response = await request(app).post("/api/content/lesson-plans").send({
      title: "测试教案",
      subject: "数学",
      grade: "三年级",
    });

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
  });
});
```

### E2E 测试示例

```javascript
// e2e/tests/lesson-plan.spec.js
import { test, expect } from "@playwright/test";

test("用户可以生成教案", async ({ page }) => {
  await page.goto("http://localhost:3000");

  await page.fill('[data-testid="subject-input"]', "数学");
  await page.fill('[data-testid="grade-input"]', "三年级");
  await page.click('[data-testid="generate-button"]');

  await expect(
    page.locator('[data-testid="lesson-plan-content"]'),
  ).toBeVisible();
});
```

## 🎛️ 测试命令详解

### 后端测试命令

```bash
cd server

# 运行所有测试
npm test

# 运行特定测试文件
npm test -- --testPathPattern=basic.test.js

# 生成覆盖率报告
npm run test:coverage

# 监视模式
npm run test:watch

# 运行集成测试
npm test -- --testPathPattern=integration

# 显示详细输出
npm test -- --verbose
```

### 前端测试命令

```bash
cd web

# 运行所有测试
npm test

# 运行特定测试文件
npm test -- StreamingMarkdown.test.tsx

# 生成覆盖率报告
npm test -- --coverage

# 非监视模式
npm test -- --watchAll=false

# 运行匹配特定模式的测试
npm test -- --testNamePattern="renders static content"
```

### E2E 测试命令

```bash
cd e2e

# 运行所有E2E测试
npm test

# 运行特定浏览器的测试
npx playwright test --project=chromium

# 显示浏览器界面
npx playwright test --headed

# 生成HTML报告
npx playwright test --reporter=html

# 调试模式
npx playwright test --debug
```

## 📊 测试结果示例

### 成功的测试输出

```
 PASS  __tests__/basic.test.js
  基础功能测试
    ✓ 数学运算测试 (1 ms)
    ✓ 字符串操作测试
    ✓ 数组操作测试
    ✓ 对象操作测试
    ✓ 异步操作测试 (102 ms)
    ✓ 错误处理测试 (5 ms)
  实用函数测试
    ✓ 计算器加法
    ✓ 计算器减法
    ✓ 计算器乘法
    ✓ 计算器除法
  日期时间测试
    ✓ 当前日期测试 (1 ms)
    ✓ 日期格式化测试
    ✓ 时间戳测试
  正则表达式测试
    ✓ 邮箱验证
    ✓ 手机号验证
    ✓ 中文字符验证
  性能测试
    ✓ 数组操作性能 (1 ms)
    ✓ 字符串操作性能
  模拟测试
    ✓ 函数模拟
    ✓ 返回值模拟
    ✓ 异步模拟

Test Suites: 1 passed, 1 total
Tests:       21 passed, 21 total
Snapshots:   0 total
Time:        0.204 s
```

## 🔧 测试配置

### Jest 配置文件

```javascript
// jest.config.js
module.exports = {
  testEnvironment: "node", // 后端使用node，前端使用jsdom
  setupFilesAfterEnv: ["<rootDir>/jest.setup.js"],
  collectCoverageFrom: [
    "**/*.{js,jsx,ts,tsx}",
    "!**/node_modules/**",
    "!**/coverage/**",
  ],
  testMatch: [
    "**/__tests__/**/*.(js|jsx|ts|tsx)",
    "**/*.(test|spec).(js|jsx|ts|tsx)",
  ],
  coverageReporters: ["text", "lcov", "html"],
  testTimeout: 30000,
  verbose: true,
};
```

### 测试设置文件

```javascript
// jest.setup.js
// Mock environment variables
process.env.NODE_ENV = "test";
process.env.QWEN_API_KEY = "test-api-key";

// Mock console to reduce noise
global.console = {
  ...console,
  log: jest.fn(),
  debug: jest.fn(),
  info: jest.fn(),
  warn: jest.fn(),
  error: jest.fn(),
};

// Global test timeout
jest.setTimeout(30000);
```

## 🚨 常见问题和解决方案

### 1. 测试超时

**问题**: 测试运行超时

```bash
Timeout - Async callback was not invoked within the 5000ms timeout
```

**解决方案**:

```javascript
// 增加单个测试超时时间
test("长时间运行的测试", async () => {
  // 测试代码
}, 10000); // 10秒超时

// 或在配置中设置全局超时
// jest.config.js
module.exports = {
  testTimeout: 30000, // 30秒
};
```

### 2. 模块找不到

**问题**:

```bash
Cannot find module '@/components/Button'
```

**解决方案**:

```javascript
// jest.config.js
module.exports = {
  moduleNameMapping: {
    "^@/(.*)$": "<rootDir>/src/$1",
  },
};
```

### 3. 异步测试问题

**问题**: 异步操作未正确处理

**解决方案**:

```javascript
// 使用 async/await
test("异步测试", async () => {
  const result = await asyncFunction();
  expect(result).toBe("expected");
});

// 使用 waitFor
import { waitFor } from "@testing-library/react";

test("等待异步更新", async () => {
  render(<AsyncComponent />);

  await waitFor(() => {
    expect(screen.getByText("加载完成")).toBeInTheDocument();
  });
});
```

## 📈 覆盖率报告

### 查看覆盖率

```bash
# 生成覆盖率报告
npm run test:coverage

# 查看HTML报告
open coverage/lcov-report/index.html
```

### 覆盖率目标

- **语句覆盖率**: > 80%
- **分支覆盖率**: > 75%
- **函数覆盖率**: > 85%
- **行覆盖率**: > 80%

## 🎯 测试最佳实践

1. **测试命名要清晰**: 使用描述性的测试名称
2. **遵循 AAA 模式**: Arrange, Act, Assert
3. **保持测试独立**: 每个测试应该独立运行
4. **使用适当的断言**: 选择最合适的 expect 方法
5. **模拟外部依赖**: 使用 Mock 隔离测试环境
6. **测试边界情况**: 包含正常和异常情况
7. **保持测试简单**: 一个测试只测试一个功能点

## 🔄 持续集成

### GitHub Actions 示例

```yaml
name: 测试

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: 设置Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "18"

      - name: 安装依赖
        run: pnpm install

      - name: 运行测试
        run: node scripts/run-tests.js
```

## 📚 更多资源

- [Jest 官方文档](https://jestjs.io/docs/getting-started)
- [React Testing Library](https://testing-library.com/docs/react-testing-library/intro/)
- [Playwright 文档](https://playwright.dev/docs/intro)
- [测试最佳实践](https://github.com/goldbergyoni/javascript-testing-best-practices)

---

## 🎉 总结

通过本指南，您学会了：

1. ✅ 如何运行不同类型的测试
2. ✅ 如何编写单元测试、集成测试和 E2E 测试
3. ✅ 如何使用测试工具和配置
4. ✅ 如何解决常见的测试问题
5. ✅ 如何生成和分析覆盖率报告

记住，好的测试不仅能发现 bug，还能作为代码的文档，帮助团队更好地理解和维护代码。

**立即开始测试**：

```bash
# 运行基础测试
cd server && npm test -- --testPathPattern=basic.test.js

# 或使用简化脚本
node scripts/simple-test.js backend
```
