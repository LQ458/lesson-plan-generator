# å®æ—¶æµå¼è¾“å‡ºåŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ä¸ºå±±æ‘æ•™å¸ˆ AI åŠ©æ‰‹åº”ç”¨æ·»åŠ äº†å®æ—¶æµå¼æ•™æ¡ˆç”ŸæˆåŠŸèƒ½ï¼Œè§£å†³äº†åŸæ¥éœ€è¦ç­‰å¾…è¾ƒé•¿æ—¶é—´çš„ç”¨æˆ·ä½“éªŒé—®é¢˜ã€‚ç”¨æˆ·ç°åœ¨å¯ä»¥çœ‹åˆ°æ•™æ¡ˆå†…å®¹å®æ—¶ç”Ÿæˆï¼Œå¤§å¤§æå‡äº†ä½¿ç”¨ä½“éªŒã€‚

## å®ç°æ¶æ„

### 1. æœåŠ¡å±‚è®¾è®¡

#### StreamingAIService (æµå¼ AI æœåŠ¡)

- **ä½ç½®**: `lib/services/streaming_ai_service.dart`
- **åŠŸèƒ½**: æä¾›å®æ—¶æµå¼è¾“å‡ºçš„ AI æœåŠ¡
- **æ”¯æŒçš„ AI æä¾›å•†**:
  - é˜¿é‡Œäº‘é€šä¹‰åƒé—® (qianwen)
  - æ·±åº¦æ±‚ç´¢ (deepseek)
  - æ™ºè°± ChatGLM (chatglm)
  - Kimi æ™ºèƒ½åŠ©æ‰‹ (kimi)

**æ ¸å¿ƒæ–¹æ³•**:

```dart
// æµå¼ç”Ÿæˆæ•™æ¡ˆ
Stream<String> generateLessonPlanStream({
  required String subject,
  required String grade,
  required String topic,
  String? requirements,
})

// æµå¼ç”Ÿæˆç»ƒä¹ é¢˜
Stream<String> generateExercisesStream({
  required String subject,
  required String grade,
  required String topic,
  required String difficulty,
  required int count,
})
```

#### AIService (ä¸» AI æœåŠ¡) - é›†æˆæ›´æ–°

- **å¢å¼º**: æ·»åŠ äº†æµå¼æ–¹æ³•çš„é›†æˆ
- **æ™ºèƒ½è·¯ç”±**: è‡ªåŠ¨é€‰æ‹©æµå¼ã€ç¦»çº¿æˆ–é™çº§æ¨¡å¼
- **å‘åå…¼å®¹**: ä¿æŒåŸæœ‰æ–¹æ³•ä¸å˜

**æ–°å¢æ–¹æ³•**:

```dart
// æµå¼ç”Ÿæˆæ•™æ¡ˆï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰
Stream<String> generateLessonPlanStream({...})

// æµå¼ç”Ÿæˆç»ƒä¹ é¢˜
Stream<String> generateExercisesStream({...})
```

### 2. ç•Œé¢å±‚è®¾è®¡

#### StreamingLessonPlanView (æµå¼æ•™æ¡ˆè§†å›¾)

- **ä½ç½®**: `lib/widgets/streaming_lesson_plan_view.dart`
- **åŠŸèƒ½**: å…¨å±æµå¼æ•™æ¡ˆç”Ÿæˆç•Œé¢

**æ ¸å¿ƒç‰¹æ€§**:

- å®æ—¶è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆ8 ä¸ªç”Ÿæˆæ­¥éª¤ï¼‰
- è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
- åœæ­¢/é‡æ–°ç”Ÿæˆ/ä¿å­˜åŠŸèƒ½
- ç¾è§‚çš„å±±æ‘æ•™å¸ˆå‹å¥½ç•Œé¢

**è¿›åº¦æ­¥éª¤**:

1. ğŸš€ è¿æ¥ AI æœåŠ¡
2. ğŸ“ åˆ†ææ•™å­¦è¦æ±‚
3. ğŸ¯ åˆ¶å®šæ•™å­¦ç›®æ ‡
4. â­ ç¡®å®šé‡ç‚¹éš¾ç‚¹
5. ğŸ“‹ è®¾è®¡æ•™å­¦è¿‡ç¨‹
6. ğŸ–¼ï¸ è§„åˆ’æ¿ä¹¦è®¾è®¡
7. ğŸ’­ å®Œå–„æ•™å­¦åæ€
8. âœ… æ•™æ¡ˆç”Ÿæˆå®Œæˆ

#### æ•™æ¡ˆç”Ÿæˆé¡µé¢æ›´æ–°

- **ä½ç½®**: `lib/screens/lesson_plan_screen.dart`
- **æ–°å¢**: åŒç”Ÿæˆæ¨¡å¼é€‰æ‹©
  - **æ™®é€šç”Ÿæˆ**: ä¼ ç»Ÿä¸€æ¬¡æ€§ç”Ÿæˆæ¨¡å¼
  - **å®æ—¶ç”Ÿæˆ**: æ–°çš„æµå¼è¾“å‡ºæ¨¡å¼

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æµå¼æ•°æ®å¤„ç†

```dart
// æ ¸å¿ƒæµå¼å¤„ç†é€»è¾‘
Stream<String> _callAIStream(String prompt) async* {
  try {
    yield 'ğŸš€ æ­£åœ¨è¿æ¥AIæœåŠ¡...\n\n';
    await Future.delayed(const Duration(milliseconds: 500));
    yield 'âœ… è¿æ¥æˆåŠŸï¼Œå¼€å§‹ç”Ÿæˆæ•™æ¡ˆ...\n\n';

    // æ¨¡æ‹Ÿæµå¼è¾“å‡ºï¼ˆçœŸå®ç¯å¢ƒä¸­ä¼šè¿æ¥åˆ°SSE APIï¼‰
    yield* _simulateStreamingOutput(prompt);
  } catch (e) {
    yield '\n\nâŒ ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼š${e.toString()}';
  }
}
```

### 2. è¿›åº¦è·Ÿè¸ªç®—æ³•

```dart
void _updateProgress() {
  final contentLength = _generatedContent.length;
  if (contentLength > 100 && _currentStep < 1) {
    _currentStep = 1;
  } else if (contentLength > 300 && _currentStep < 2) {
    _currentStep = 2;
  }
  // ... æ›´å¤šæ­¥éª¤
}
```

### 3. æ™ºèƒ½æœåŠ¡è·¯ç”±

```dart
// æ™ºèƒ½é€‰æ‹©æœ€ä½³æœåŠ¡
if (forceOffline && _isModelLoaded) {
  // å¼ºåˆ¶ç¦»çº¿æ¨¡å¼
  yield* _offlineGeneration();
} else if (await _isOnlineAvailable()) {
  // åœ¨çº¿æµå¼æ¨¡å¼
  yield* _streamingAI.generateLessonPlanStream(...);
} else if (_isModelLoaded) {
  // é™çº§åˆ°ç¦»çº¿æ¨¡å¼
  yield* _offlineGeneration();
} else {
  // é”™è¯¯æç¤º
  yield 'ğŸ˜Š è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥...';
}
```

## ç”¨æˆ·ç•Œé¢ç‰¹æ€§

### 1. åŒæ¨¡å¼è®¾è®¡

- **æ™®é€šç”Ÿæˆ**: é€‚åˆç½‘ç»œè¾ƒæ…¢æˆ–å–œæ¬¢ä¼ ç»Ÿæ¨¡å¼çš„ç”¨æˆ·
- **å®æ—¶ç”Ÿæˆ**: é€‚åˆæƒ³è¦å®æ—¶æŸ¥çœ‹è¿›åº¦çš„ç”¨æˆ·

### 2. è§†è§‰åé¦ˆ

- **è¿›åº¦æ¡**: æ˜¾ç¤ºç”Ÿæˆè¿›åº¦ç™¾åˆ†æ¯”
- **æ­¥éª¤æŒ‡ç¤º**: æ¸…æ™°æ˜¾ç¤ºå½“å‰ç”Ÿæˆé˜¶æ®µ
- **å®æ—¶å†…å®¹**: å†…å®¹é€æ®µæ˜¾ç¤ºï¼Œä¿æŒç”¨æˆ·å‚ä¸æ„Ÿ

### 3. äº¤äº’æ§åˆ¶

- **åœæ­¢ç”Ÿæˆ**: ç”¨æˆ·å¯éšæ—¶ä¸­æ–­ç”Ÿæˆè¿‡ç¨‹
- **é‡æ–°ç”Ÿæˆ**: ä¸æ»¡æ„æ—¶å¯ä»¥é‡æ–°å¼€å§‹
- **ä¿å­˜æ•™æ¡ˆ**: ç”Ÿæˆå®Œæˆåä¸€é”®ä¿å­˜

## å±±æ‘æ•™å¸ˆå‹å¥½è®¾è®¡

### 1. ç®€æ´æ˜äº†çš„æç¤º

- ä½¿ç”¨ emoji å¢å¼ºè§†è§‰æ•ˆæœ
- ä¸­æ–‡æç¤ºä¿¡æ¯ï¼Œç¬¦åˆç›®æ ‡ç”¨æˆ·ç¾¤ä½“
- æ“ä½œæŒ‡å¼•æ¸…æ™°æ˜“æ‡‚

### 2. ç½‘ç»œé€‚åº”æ€§

- è‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶å†µ
- æ™ºèƒ½é™çº§åˆ°ç¦»çº¿æ¨¡å¼
- å‹å¥½çš„é”™è¯¯æç¤ºå’Œè§£å†³å»ºè®®

### 3. å†…å®¹æ ¼å¼åŒ–

- è‡ªåŠ¨åº”ç”¨æ¿ä¹¦è®¾è®¡ä¼˜åŒ–
- ç®€çº¦é…è‰²æ–¹æ¡ˆ
- é€‚é…æ·±è‰²/æµ…è‰²ä¸»é¢˜

## æŠ€æœ¯ä¼˜åŠ¿

### 1. ç”¨æˆ·ä½“éªŒæå‡

- âœ… æ¶ˆé™¤é•¿æ—¶é—´ç­‰å¾…
- âœ… å®æ—¶è¿›åº¦åé¦ˆ
- âœ… å¯æ§çš„ç”Ÿæˆè¿‡ç¨‹

### 2. æŠ€æœ¯å…ˆè¿›æ€§

- âœ… Server-Sent Events (SSE) æ”¯æŒ
- âœ… æµå¼æ•°æ®å¤„ç†
- âœ… æ™ºèƒ½æœåŠ¡è·¯ç”±

### 3. ç¨³å®šæ€§ä¿éšœ

- âœ… å¤šç§é™çº§æ–¹æ¡ˆ
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… å‘åå…¼å®¹ä¿è¯

## æœªæ¥æ‰©å±•

### 1. çœŸå® SSE é›†æˆ

å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæµå¼è¾“å‡ºï¼Œæœªæ¥å¯ä»¥ç›´æ¥è¿æ¥åˆ°æ”¯æŒ SSE çš„ AI APIï¼š

```dart
// çœŸå®SSEå®ç°ç¤ºä¾‹
Stream<String> _connectToSSE(String apiUrl, Map<String, dynamic> payload) async* {
  final client = SseClient.connect(apiUrl);
  await for (final message in client.stream) {
    if (message.data != null) {
      yield message.data!;
    }
  }
}
```

### 2. å¤šè¯­è¨€æ”¯æŒ

- æ”¯æŒæ–¹è¨€ç‰ˆæœ¬ï¼ˆé€‚åº”ä¸åŒåœ°åŒºå±±æ‘æ•™å¸ˆï¼‰
- å›½é™…åŒ–æ‰©å±•

### 3. é«˜çº§åŠŸèƒ½

- è¯­éŸ³è¾“å…¥æ”¯æŒ
- å›¾åƒè¯†åˆ«å¢å¼º
- ä¸ªæ€§åŒ–æ¨è

## ç¼–è¯‘çŠ¶æ€

âœ… **ç¼–è¯‘æˆåŠŸ**: `flutter build web --release` é€šè¿‡
âœ… **ä»£ç åˆ†æ**: ä¸»è¦åŠŸèƒ½é”™è¯¯å·²ä¿®å¤
âœ… **å‘åå…¼å®¹**: åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜

## ä½¿ç”¨æ–¹å¼

1. **è¿›å…¥æ•™æ¡ˆç”Ÿæˆé¡µé¢**
2. **å¡«å†™æ•™å­¦ä¿¡æ¯**ï¼ˆç§‘ç›®ã€å¹´çº§ã€è¯¾é¢˜ç­‰ï¼‰
3. **é€‰æ‹©ç”Ÿæˆæ¨¡å¼**ï¼š
   - ç‚¹å‡»"æ™®é€šç”Ÿæˆ"ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
   - ç‚¹å‡»"å®æ—¶ç”Ÿæˆ"ä½¿ç”¨æµå¼è¾“å‡ºæ¨¡å¼
4. **äº«å—å®æ—¶ç”Ÿæˆä½“éªŒ**ï¼Œè§‚çœ‹æ•™æ¡ˆé€æ­¥ç”Ÿæˆ
5. **å®Œæˆåä¿å­˜**æ•™æ¡ˆåˆ°æœ¬åœ°æ”¶è—

---

> ğŸ’¡ **è®¾è®¡ç†å¿µ**: è®©æŠ€æœ¯æœåŠ¡æ•™è‚²ï¼Œè®© AI åŠ©åŠ›å±±æ‘æ•™å¸ˆæ›´é«˜æ•ˆåœ°å¤‡è¯¾ï¼Œè®©æ¯ä¸€ä½åè¿œåœ°åŒºçš„è€å¸ˆéƒ½èƒ½äº«å—åˆ°æœ€å…ˆè¿›çš„æ•™å­¦è¾…åŠ©å·¥å…·ã€‚
